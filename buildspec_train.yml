version: 0.2

phases:
  install:
    runtime-versions:
      python: 3.8
    commands:
      - pip install pandas scikit-learn boto3 sagemaker
      - apt-get update && apt-get install -y jq bc  # Install jq and bc
  
  pre_build:
    commands:
      - echo "Setting up SageMaker training job"
      - mkdir -p /tmp/model /tmp/data
  
  build:
    commands:
      - echo "Starting model training"
      - aws s3 cp --recursive s3://${DATA_BUCKET}/processed_data/ /tmp/data/ || aws s3 cp s3://${DATA_BUCKET}/raw_data.csv /tmp/data/
      - python model/train.py --train-data-path /tmp/data --validation-data-path /tmp/data --model-dir /tmp/model
      - aws s3 cp --recursive /tmp/model/ s3://${MODEL_BUCKET}/model/
      - python model/evaluate.py --model-path /tmp/model/model.pkl --test-data-path /tmp/data --output-dir /tmp/model
      - aws s3 cp /tmp/model/evaluation.json s3://${MODEL_BUCKET}/evaluation/evaluation.json
  
  post_build:
    commands:
      - echo "Training completed on `date`"
      - |
        if [ -f /tmp/model/metrics.json ]; then
          echo "Metrics file found"
          cat /tmp/model/metrics.json
          # Check if jq is available
          if command -v jq &> /dev/null; then
            ACCURACY=$(jq -r '.accuracy' /tmp/model/metrics.json || echo "0")
            echo "Extracted accuracy: $ACCURACY"
            # Check if bc is available
            if command -v bc &> /dev/null; then
              if (( $(echo "$ACCURACY > 0.8" | bc -l) )); then
                echo "Model accuracy meets threshold, proceeding with registration"
                MODEL_PACKAGE_GROUP_NAME="my-model-package-group"
                aws sagemaker create-model-package-group --model-package-group-name $MODEL_PACKAGE_GROUP_NAME --model-package-group-description "My model package group" || true
              else
                echo "Model accuracy below threshold, but continuing pipeline"
              fi
            else
              echo "bc command not found, skipping accuracy check"
            fi
          else
            echo "jq command not found, skipping accuracy check"
          fi
        else
          echo "Metrics file not found at /tmp/model/metrics.json"
          ls -la /tmp/model/
        fi
        # Don't fail the build even if accuracy is low
        exit 0

artifacts:
  files:
    - model/**/*
    - /tmp/model/metrics.json
    - /tmp/model/evaluation.json
