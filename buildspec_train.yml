version: 0.2

phases:
  install:
    runtime-versions:
      python: 3.8
    commands:
      - pip install pandas scikit-learn boto3 sagemaker
  
  pre_build:
    commands:
      - echo "Setting up SageMaker training job"
      - mkdir -p /tmp/model
  
  build:
    commands:
      - echo "Starting model training"
      - aws s3 cp --recursive s3://${DATA_BUCKET}/processed_data/ /tmp/data/
      - python model/train.py --train-data-path /tmp/data --validation-data-path /tmp/data --model-dir /tmp/model
      - aws s3 cp --recursive /tmp/model/ s3://${MODEL_BUCKET}/model/
      - python model/evaluate.py --model-path /tmp/model/model.pkl --test-data-path /tmp/data --output-dir /tmp/model
      - aws s3 cp /tmp/model/evaluation.json s3://${MODEL_BUCKET}/evaluation/evaluation.json
  
  post_build:
    commands:
      - echo "Training completed on `date`"
      - |
        ACCURACY=$(cat /tmp/model/metrics.json | jq -r '.accuracy')
        if (( $(echo "$ACCURACY > 0.8" | bc -l) )); then
          echo "Model accuracy meets threshold, proceeding with registration"
          MODEL_PACKAGE_GROUP_NAME="my-model-package-group"
          aws sagemaker create-model-package-group --model-package-group-name $MODEL_PACKAGE_GROUP_NAME --model-package-group-description "My model package group" || true
          # Additional commands to register model with SageMaker Model Registry would go here
        else
          echo "Model accuracy below threshold, skipping registration"
          exit 1
        fi

artifacts:
  files:
    - model/**/*
    - /tmp/model/metrics.json
    - /tmp/model/evaluation.json
